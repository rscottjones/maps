{{/*
  Maps for Micro.blog (Hugo Shortcode)
  =====================================
  Fully self-contained ‚Äî works with ANY theme (mnml, Tiny, etc.)
  No head partial, footer partial, or microhook needed.
  Leaflet is loaded on demand and only once, even with multiple maps.
  Includes CSS overrides for themes (like mnml) that interfere with
  Leaflet marker/tile positioning.

  Usage (positional):
    {{< map "europe" >}}
    {{< map "south-america" >}}

  Usage (named ‚Äî required when setting optional params):
    {{< map source="europe" >}}
    {{< map source="europe" height="700px" >}}
    {{< map source="europe" color="#E11D48" >}}
    {{< map source="europe" icon="circle-dot" >}}
    {{< map source="europe" legend="europe-legend" >}}

  Parameters:
    source / positional 0  ‚Äî (required) name of the YAML file in data/
    height                 ‚Äî map container height (default: "500px")
    color                  ‚Äî default pin color (default: "#4682B4" SteelBlue)
    icon                   ‚Äî default icon shape (default: "pin")
    legend                 ‚Äî name of a legend YAML file in data/ (optional)

  Data file fields (name, lat, lon required; url, color, icon, description optional):
    - name: "Porto, Portugal"
      lat: 41.1579
      lon: -8.6291
      url: "/categories/porto"
      color: "Green"
      icon: "circle-check"
      description: "Three days exploring the Ribeira district."

  Legend file format (label required; icon, color, url optional):
    - label: "Visited"
      icon: "circle-check"
      color: "Green"
      url: "#visited"
    - label: "Wishlist"
      icon: "pin"

  Links in popups open in a new tab by default. If a url points to an
  image file (.jpg, .png, .gif, .webp), clicking it opens a lightbox
  overlay instead of navigating away.

  Available icons:
    Standalone shapes:  pin (default), pin-small, star, heart, point, camera, video, image, gallery
    Circle badges:      circle-check, circle-x, circle-heart, circle-star, circle-dot, circle-new
    Numbered circles:   circle-0 through circle-9, circle-00 through circle-99
    Emoji / unicode:    Any other value is rendered as-is (e.g., "üèØ", "üçï")
*/}}

{{/* ‚îÄ‚îÄ Resolve the data source name ‚îÄ‚îÄ */}}
{{ $source := "" }}
{{ if .IsNamedParams }}
  {{ $source = .Get "source" }}
{{ else }}
  {{ $source = .Get 0 }}
{{ end }}

{{/* ‚îÄ‚îÄ Optional parameters with defaults ‚îÄ‚îÄ */}}
{{ $height := "500px" }}
{{ $color := "#4682B4" }}
{{ $icon := "pin" }}
{{ $legendSource := "" }}
{{ if .IsNamedParams }}
  {{ with .Get "height" }}{{ $height = . }}{{ end }}
  {{ with .Get "color" }}{{ $color = . }}{{ end }}
  {{ with .Get "icon" }}{{ $icon = . }}{{ end }}
  {{ with .Get "legend" }}{{ $legendSource = . }}{{ end }}
{{ end }}

{{/* ‚îÄ‚îÄ Build a unique map ID from the source name ‚îÄ‚îÄ */}}
{{ $mapID := printf "map-%s" $source }}
{{ $legendID := printf "legend-%s" $source }}

{{/* ‚îÄ‚îÄ Look up the data files ‚îÄ‚îÄ */}}
{{ $locations := index .Site.Data $source }}
{{ $legend := false }}
{{ if $legendSource }}
  {{ $legend = index .Site.Data $legendSource }}
{{ end }}

{{ if $locations }}
{{/* ‚îÄ‚îÄ Inject Leaflet CSS overrides once per page ‚îÄ‚îÄ */}}
<style>
  /* Fix Leaflet markers ‚Äî override theme styles (mnml, etc.)
     that apply max-width, border-radius, or margins to img tags
     inside article elements, which shifts pins and tiles. */
  article .leaflet-container img,
  .leaflet-container img {
    max-width: none !important;
    width: auto !important;
    border-radius: 0 !important;
    display: block !important;
  }
  article .leaflet-marker-icon,
  article .leaflet-marker-shadow,
  .leaflet-marker-icon,
  .leaflet-marker-shadow {
    max-width: none !important;
  }
  article .leaflet-tile,
  .leaflet-tile {
    margin: 0 !important;
    max-width: none !important;
  }
  /* Lightbox overlay */
  .map-lightbox {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10000;
    background: rgba(0,0,0,0.85);
    cursor: pointer;
    justify-content: center;
    align-items: center;
  }
  .map-lightbox.active {
    display: flex;
  }
  .map-lightbox img {
    max-width: 85vw;
    max-height: 85vh;
    border-radius: 4px;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    object-fit: contain;
    cursor: default;
  }
  .map-lightbox-caption {
    position: absolute;
    bottom: 20px;
    left: 0; right: 0;
    text-align: center;
    color: #ddd;
    font-family: sans-serif;
    font-size: 14px;
    pointer-events: none;
  }
  .map-lightbox-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 36px;
    cursor: pointer;
    padding: 16px;
    line-height: 1;
    user-select: none;
    -webkit-user-select: none;
    transition: color 0.15s;
  }
  .map-lightbox-arrow:hover {
    color: #fff;
  }
  .map-lightbox-prev { left: 8px; }
  .map-lightbox-next { right: 8px; }
  .map-lightbox-counter {
    position: absolute;
    top: 16px;
    right: 20px;
    color: rgba(255,255,255,0.6);
    font-family: sans-serif;
    font-size: 14px;
    pointer-events: none;
  }
</style>
<div id="{{ $mapID }}" style="width: 100%; height: {{ $height }}; border-radius: {{ if $legend }}12px 12px 0 0{{ else }}12px{{ end }}; margin: {{ if $legend }}30px 0 0{{ else }}30px 0{{ end }};"></div>
{{ if $legend }}
<div id="{{ $legendID }}" style="background: #f0f0f0; border-radius: 0 0 12px 12px; padding: 12px 16px; margin: 0 0 30px; display: flex; flex-wrap: wrap; gap: 20px; row-gap: 10px; align-items: center; font-family: sans-serif; font-size: 14px; color: #444;"></div>
{{ end }}
<script>
(function() {
  var MAP_ID = {{ $mapID | jsonify | safeJS }};
  var LEGEND_ID = {{ $legendID | jsonify | safeJS }};
  var DEFAULT_COLOR = {{ $color | jsonify | safeJS }};
  var DEFAULT_ICON = {{ $icon | jsonify | safeJS }};

  /* ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ */
  var IMAGE_EXTS = /\.(jpe?g|png|gif|webp)(\?.*)?$/i;

  function isImageUrl(url) {
    return url && IMAGE_EXTS.test(url);
  }

  function ensureLightbox() {
    if (document.getElementById('map-lightbox')) return;
    var overlay = document.createElement('div');
    overlay.id = 'map-lightbox';
    overlay.className = 'map-lightbox';
    overlay.innerHTML = '<button class="map-lightbox-arrow map-lightbox-prev">&#8249;</button>'
      + '<img src="" alt="" />'
      + '<button class="map-lightbox-arrow map-lightbox-next">&#8250;</button>'
      + '<div class="map-lightbox-counter"></div>'
      + '<div class="map-lightbox-caption"></div>';
    document.body.appendChild(overlay);

    var img = overlay.querySelector('img');
    var caption = overlay.querySelector('.map-lightbox-caption');
    var counter = overlay.querySelector('.map-lightbox-counter');
    var prevBtn = overlay.querySelector('.map-lightbox-prev');
    var nextBtn = overlay.querySelector('.map-lightbox-next');
    var gallery = [];
    var currentIdx = 0;

    function show(idx) {
      if (idx < 0 || idx >= gallery.length) return;
      currentIdx = idx;
      img.src = gallery[idx].url;
      caption.textContent = gallery[idx].name || '';
      var hasMultiple = gallery.length > 1;
      counter.textContent = hasMultiple ? (idx + 1) + ' / ' + gallery.length : '';
      prevBtn.style.display = hasMultiple && idx > 0 ? '' : 'none';
      nextBtn.style.display = hasMultiple && idx < gallery.length - 1 ? '' : 'none';
    }

    function close() { overlay.classList.remove('active'); }

    /* Close on backdrop click (not on img or arrows) */
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) close();
    });

    prevBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      show(currentIdx - 1);
    });

    nextBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      show(currentIdx + 1);
    });

    img.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    /* Keyboard navigation */
    document.addEventListener('keydown', function(e) {
      if (!overlay.classList.contains('active')) return;
      if (e.key === 'Escape') close();
      else if (e.key === 'ArrowLeft') show(currentIdx - 1);
      else if (e.key === 'ArrowRight') show(currentIdx + 1);
    });

    /* Swipe support */
    var touchStartX = 0;
    var touchStartY = 0;
    overlay.addEventListener('touchstart', function(e) {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    overlay.addEventListener('touchend', function(e) {
      var dx = e.changedTouches[0].screenX - touchStartX;
      var dy = e.changedTouches[0].screenY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
        if (dx < 0) show(currentIdx + 1);
        else show(currentIdx - 1);
      }
    }, { passive: true });

    window.__mapLightbox = {
      open: function(images, startIdx) {
        gallery = images;
        show(startIdx || 0);
        overlay.classList.add('active');
      }
    };
  }

  var locations = [
    {{ range $locations }}
    {
      name: {{ .name | jsonify | safeJS }},
      lat: {{ .lat }},
      lon: {{ .lon }},
      url: {{ with .url }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }},
      color: {{ with .color }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }},
      icon: {{ with .icon }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }},
      description: {{ with .description }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }}
    },
    {{ end }}
  ];

  {{ if $legend }}
  var legendItems = [
    {{ range $legend }}
    {
      label: {{ .label | jsonify | safeJS }},
      icon: {{ with .icon }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }},
      color: {{ with .color }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }},
      url: {{ with .url }}{{ . | jsonify | safeJS }}{{ else }}""{{ end }}
    },
    {{ end }}
  ];
  {{ else }}
  var legendItems = [];
  {{ end }}

  /* ‚îÄ‚îÄ Icon shape definitions ‚îÄ‚îÄ */
  var SHAPES = {
    pin: {
      w: 25, h: 41, anchor: [12, 41], popup: [1, -34], shadow: true,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41">'
          + '<path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 21.9 12.5 41 12.5 41S25 21.9 25 12.5C25 5.6 19.4 0 12.5 0Z" fill="' + c + '"/>'
          + '<circle cx="12.5" cy="12.5" r="5.5" fill="#fff"/></svg>';
      }
    },
    star: {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="' + c + '"/></svg>';
      }
    },
    heart: {
      w: 26, h: 26, anchor: [13, 15], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53L12 21.35z" fill="' + c + '"/></svg>';
      }
    },
    point: {
      w: 8, h: 8, anchor: [4, 4], popup: [0, -4], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">'
          + '<circle cx="4" cy="4" r="4" fill="' + c + '"/></svg>';
      }
    },
    'circle-check': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<polyline points="7,12.5 10.5,16 17,8.5" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      }
    },
    'circle-x': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<line x1="8" y1="8" x2="16" y2="16" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>'
          + '<line x1="16" y1="8" x2="8" y2="16" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/></svg>';
      }
    },
    'circle-heart': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<g transform="translate(4.8,4.8) scale(0.6)">'
          + '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53L12 21.35z" fill="#fff"/>'
          + '</g></svg>';
      }
    },
    'circle-star': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<g transform="translate(4.8,4.8) scale(0.6)">'
          + '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="#fff"/>'
          + '</g></svg>';
      }
    },
    'circle-dot': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<circle cx="12" cy="12" r="4" fill="#fff"/></svg>';
      }
    },
    camera: {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" fill="' + c + '"/>'
          + '<circle cx="12" cy="13" r="4" fill="none" stroke="#fff" stroke-width="2"/></svg>';
      }
    },
    video: {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<rect x="1" y="5" width="15" height="14" rx="2" fill="' + c + '"/>'
          + '<path d="M18 8.5l5-3v13l-5-3v-7z" fill="' + c + '"/></svg>';
      }
    },
    image: {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<rect x="2" y="4" width="20" height="16" rx="2" fill="' + c + '"/>'
          + '<circle cx="7.5" cy="9" r="2" fill="#fff"/>'
          + '<polygon points="2,20 8,14 11,17 14,12 22,20" fill="rgba(255,255,255,0.4)"/></svg>';
      }
    },
    gallery: {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<rect x="5" y="2" width="17" height="13" rx="2" fill="' + c + '" opacity="0.5"/>'
          + '<rect x="2" y="6" width="17" height="14" rx="2" fill="' + c + '"/>'
          + '<circle cx="7" cy="10.5" r="1.5" fill="#fff"/>'
          + '<polygon points="2,20 7,14 9.5,16.5 12,12 19,20" fill="rgba(255,255,255,0.4)"/></svg>';
      }
    },
    'pin-small': {
      w: 16, h: 26, anchor: [8, 26], popup: [0, -22],
      shadow: true, shadowSize: [26, 26], shadowAnchor: [8, 26],
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="26" viewBox="0 0 25 41">'
          + '<path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 21.9 12.5 41 12.5 41S25 21.9 25 12.5C25 5.6 19.4 0 12.5 0Z" fill="' + c + '"/>'
          + '<circle cx="12.5" cy="12.5" r="5.5" fill="#fff"/></svg>';
      }
    },
    'circle-new': {
      w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
      svg: function(c) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
          + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
          + '<text x="12" y="13" text-anchor="middle" dominant-baseline="central" '
          + 'font-family="Arial,Helvetica,sans-serif" font-weight="bold" font-size="8" fill="#fff" '
          + 'letter-spacing="0.5">NEW</text></svg>';
      }
    }
  };

  /* Generate numbered circle badges: circle-0 to circle-9 (single digit)
     and circle-00 to circle-99 (two-digit, zero-padded) */
  (function() {
    function addNum(key, label, fs) {
      SHAPES[key] = {
        w: 26, h: 26, anchor: [13, 13], popup: [0, -13], shadow: false,
        svg: (function(n, f) {
          return function(c) {
            return '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">'
              + '<circle cx="12" cy="12" r="12" fill="' + c + '"/>'
              + '<text x="12" y="13" text-anchor="middle" dominant-baseline="central" '
              + 'font-family="Arial,Helvetica,sans-serif" font-weight="bold" font-size="' + f + '" fill="#fff">'
              + n + '</text></svg>';
          };
        })(label, fs)
      };
    }
    /* Single digits: circle-0 through circle-9 */
    for (var i = 0; i <= 9; i++) {
      addNum('circle-' + i, String(i), '12');
    }
    /* Two-digit zero-padded: circle-00 through circle-99 */
    for (var j = 0; j <= 99; j++) {
      var padded = (j < 10 ? '0' : '') + j;
      addNum('circle-' + padded, padded, '10');
    }
  })();

  var iconCache = {};
  function createIcon(shape, fillColor) {
    var key = shape + '|' + fillColor;
    if (iconCache[key]) return iconCache[key];
    var def = SHAPES[shape];
    var icon;
    if (def) {
      var opts = {
        iconUrl: 'data:image/svg+xml;base64,' + btoa(def.svg(fillColor)),
        iconSize: [def.w, def.h],
        iconAnchor: def.anchor,
        popupAnchor: def.popup
      };
      if (def.shadow) {
        opts.shadowUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png';
        opts.shadowSize = def.shadowSize || [41, 41];
        opts.shadowAnchor = def.shadowAnchor || [12, 41];
      }
      icon = L.icon(opts);
    } else {
      /* Treat unrecognized icon values as emoji / unicode */
      icon = L.divIcon({
        html: '<span style="font-size:24px;line-height:1;">' + shape + '</span>',
        className: '',
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        popupAnchor: [0, -14]
      });
    }
    iconCache[key] = icon;
    return icon;
  }

  /* ‚îÄ‚îÄ Legend builder ‚îÄ‚îÄ */

  function buildLegend() {
    if (!legendItems.length) return;
    var el = document.getElementById(LEGEND_ID);
    if (!el) return;
    legendItems.forEach(function(item, idx) {
      if (idx > 0) {
        var sep = document.createElement('span');
        sep.style.cssText = 'color:#ccc;font-size:8px;flex-shrink:0;';
        sep.textContent = '\u25C6';
        el.appendChild(sep);
      }
      var shape = item.icon || DEFAULT_ICON;
      var color = item.color || DEFAULT_COLOR;
      var entry = document.createElement('span');
      entry.style.cssText = 'display:inline-flex;align-items:center;gap:6px;white-space:nowrap;';
      var def = SHAPES[shape];
      var iconHTML;
      if (def) {
        iconHTML = '<img src="data:image/svg+xml;base64,' + btoa(def.svg(color))
          + '" width="18" height="18" style="vertical-align:middle;display:inline-block;" />';
      } else {
        iconHTML = '<span style="font-size:18px;line-height:1;vertical-align:middle;">' + shape + '</span>';
      }
      var labelHTML = item.url
        ? '<a href="' + item.url + '" style="color:#444;text-decoration:underline;">' + item.label + '</a>'
        : item.label;
      entry.innerHTML = iconHTML + '<span>' + labelHTML + '</span>';
      el.appendChild(entry);
    });
  }

  function initMap() {
    var container = document.getElementById(MAP_ID);
    if (!container) return;

    ensureLightbox();

    /* Collect all image URLs for gallery browsing */
    var imageGallery = [];
    locations.forEach(function(loc) {
      if (loc.url && isImageUrl(loc.url)) {
        imageGallery.push({ url: loc.url, name: loc.name });
      }
    });

    /* Intercept lightbox trigger clicks in popups */
    container.addEventListener('click', function(e) {
      var link = e.target.closest('.map-lightbox-trigger');
      if (link) {
        e.preventDefault();
        var linkUrl = link.getAttribute('href');
        var idx = 0;
        for (var i = 0; i < imageGallery.length; i++) {
          if (imageGallery[i].url === linkUrl) { idx = i; break; }
        }
        window.__mapLightbox.open(imageGallery, idx);
      }
    });

    var map = L.map(MAP_ID, { scrollWheelZoom: false });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '\u00a9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);

    var bounds = [];

    locations.forEach(function(loc) {
      var pinColor = loc.color || DEFAULT_COLOR;
      var shape = loc.icon || DEFAULT_ICON;
      var icon = createIcon(shape, pinColor);
      var marker = L.marker([loc.lat, loc.lon], { icon: icon }).addTo(map);
      var nameHTML;
      if (loc.url && isImageUrl(loc.url)) {
        nameHTML = '<h3 style="margin: 0; font-size: 16px;"><a href="' + loc.url + '" class="map-lightbox-trigger" style="color: #007bff;">' + loc.name + '</a></h3>';
      } else if (loc.url) {
        nameHTML = '<h3 style="margin: 0; font-size: 16px;"><a href="' + loc.url + '" target="_blank" rel="noopener" style="color: #007bff;">' + loc.name + '</a></h3>';
      } else {
        nameHTML = '<h3 style="margin: 0; font-size: 16px;">' + loc.name + '</h3>';
      }
      var popupContent = '<div style="font-family: sans-serif; padding: 5px;">'
        + nameHTML
        + (loc.description
          ? '<p style="margin: 6px 0 0; font-size: 14px; color: #444;">' + loc.description + '</p>'
          : '')
        + '</div>';
      marker.bindPopup(popupContent);
      bounds.push([loc.lat, loc.lon]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    }

    buildLegend();
  }

  /*
   * Leaflet loader with queue ‚Äî handles multiple maps on one page.
   * First map triggers the load; others queue up until it is ready.
   */
  if (typeof L !== 'undefined') {
    initMap();
  } else if (window.__leafletLoading) {
    window.__leafletQueue.push(initMap);
  } else {
    window.__leafletLoading = true;
    window.__leafletQueue = [initMap];

    var css = document.createElement('link');
    css.rel = 'stylesheet';
    css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(css);

    var js = document.createElement('script');
    js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    js.onload = function() {
      window.__leafletQueue.forEach(function(fn) { fn(); });
      window.__leafletQueue = [];
      window.__leafletLoading = false;
    };
    document.head.appendChild(js);
  }
})();
</script>
{{ else }}
<!-- map shortcode: No data file found at data/{{ $source }}.yml -->
{{ end }}
